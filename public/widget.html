<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shoreline Dental Chicago - Chat Widget Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }

    .demo-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .demo-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .demo-header h1 {
      color: #1f2937;
      margin-bottom: 10px;
    }

    .demo-header p {
      color: #6b7280;
    }

    /* Chat Widget Styles - Modernized Shoreline Dental  */
    #chat-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
    }

    #chat-button {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #2C5F8D;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    #chat-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    #chat-button svg {
      width: 32px;
      height: 32px;
      fill: white;
    }

    #chat-window {
      position: fixed;
      bottom: 104px;
      right: 20px;
      width: 400px;
      height: 600px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.25);
      display: none;
      flex-direction: column;
      overflow: hidden;
      animation: slideUp 0.3s ease-out;
      transition: all 0.3s ease;
    }

    #chat-window.active {
      display: flex;
    }

    #chat-window.expanded {
      width: 90vw;
      max-width: 1200px;
      height: 90vh;
      right: 50%;
      transform: translateX(50%);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chat-header {
      background: #2C5F8D;
      color: white;
      padding: 24px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 20px 20px 0 0;
    }

    .chat-header-content {
      flex: 1;
    }

    .chat-header-content h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .chat-header-content p {
      margin: 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .chat-header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .header-button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      position: relative;
    }

    .header-button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .header-button svg {
      width: 18px;
      height: 18px;
      fill: white;
    }

    .header-button .tooltip {
      position: absolute;
      bottom: -32px;
      right: 0;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .header-button:hover .tooltip {
      opacity: 1;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f8f9fa;
    }

    .chat-messages::-webkit-scrollbar {
      width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    .message {
      margin-bottom: 16px;
      animation: fadeIn 0.3s;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #4A90A4;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 16px;
    }

    .message.user .message-avatar {
      background: #2C5F8D;
    }

    .message-wrapper {
      flex: 1;
      max-width: 75%;
    }

    .message-content {
      padding: 14px 18px;
      border-radius: 16px;
      word-wrap: break-word;
      line-height: 1.5;
      font-size: 15px;
    }

    .message.user .message-content {
      background: #2C5F8D;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
      background: white;
      color: #1f2937;
      border: 1px solid #e5e7eb;
      border-bottom-left-radius: 4px;
    }

    .message-time {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 6px;
      padding: 0 4px;
    }

    .suggested-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease-out;
    }

    .suggested-action {
      background: white;
      border: 2px solid #4A90A4;
      color: #2C5F8D;
      padding: 12px 18px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      text-align: center;
      flex: 1;
      min-width: 200px;
    }

    .suggested-action:hover {
      background: #4A90A4;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74, 144, 164, 0.3);
    }

    .suggested-action:active {
      transform: translateY(0);
    }

    .typing-indicator {
      display: none;
      padding: 14px 18px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      width: fit-content;
      border-bottom-left-radius: 4px;
    }

    .typing-indicator.active {
      display: block;
    }

    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4A90A4;
      margin: 0 2px;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
      30% { transform: translateY(-10px); opacity: 1; }
    }

    .chat-input-container {
      padding: 16px 20px;
      background: white;
      border-top: 1px solid #e5e7eb;
    }

    .chat-input-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #chat-input {
      flex: 1;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
    }

    #chat-input:focus {
      border-color: #4A90A4;
    }

    #send-button {
      width: 44px;
      height: 44px;
      background: #2C5F8D;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    #send-button:hover:not(:disabled) {
      background: #4A90A4;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(44, 95, 141, 0.3);
    }

    #send-button:active:not(:disabled) {
      transform: translateY(0);
    }

    #send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #send-button svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    .context-info {
      font-size: 11px;
      color: #6b7280;
      padding: 8px 16px;
      background: #f3f4f6;
      border-radius: 6px;
      margin-top: 8px;
    }

    /* Mobile responsive */
    @media (max-width: 480px) {
      #chat-widget {
        right: 10px;
        bottom: 10px;
      }

      #chat-window {
        width: calc(100vw - 20px);
        height: calc(100vh - 100px);
        right: 10px;
        bottom: 84px;
      }

      #chat-window.expanded {
        width: calc(100vw - 20px);
        height: calc(100vh - 100px);
        transform: none;
        right: 10px;
      }

      #chat-button {
        width: 56px;
        height: 56px;
      }

      .chat-header {
        padding: 20px 16px;
      }

      .chat-header-content h3 {
        font-size: 16px;
      }

      .chat-header-content p {
        font-size: 12px;
      }

      .suggested-action {
        min-width: 100%;
      }

      .message-wrapper {
        max-width: 85%;
      }

      .header-button {
        width: 36px;
        height: 36px;
      }
    }
  </style>
  <!-- Vercel Analytics -->
  <script defer src="/_vercel/insights/script.js"></script>
  <!-- Web Vitals Tracking -->
  <script defer src="/web-vitals.js"></script>
</head>
<body>
  <div class="demo-container">
    <div class="demo-header">
      <h1>ðŸ¦· Shoreline Dental Chicago - Chat Widget Demo</h1>
      <p>Click the chat button in the bottom-right corner to start a conversation</p>
    </div>
  </div>

  <!-- Chat Widget -->
  <div id="chat-widget">
    <button id="chat-button" aria-label="Open chat">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
      </svg>
    </button>

    <div id="chat-window">
      <div class="chat-header">
        <div class="chat-header-content">
          <h3>Welcome to Shoreline Dental Chicago</h3>
          <p>Speak to me in any language!</p>
        </div>
        <div class="chat-header-actions">
          <button class="header-button" id="expand-button" aria-label="Expand chat">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
            </svg>
            <span class="tooltip">Expand</span>
          </button>
          <button class="header-button" id="refresh-button" aria-label="Restart conversation">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            <span class="tooltip">Restart</span>
          </button>
          <button class="header-button" id="close-button" aria-label="Close chat">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
            <span class="tooltip">Close</span>
          </button>
        </div>
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="message assistant">
          <div class="message-avatar">ðŸ¤–</div>
          <div class="message-wrapper">
            <div class="message-content">
              ðŸ‘‹ Hello! What can I do for you today?
            </div>
          </div>
        </div>
        <div class="suggested-actions" id="suggested-actions">
          <button class="suggested-action">I'd like to schedule an appointment</button>
        </div>
        <div class="typing-indicator" id="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <input type="text" id="chat-input" placeholder="Type something..." />
          <button id="send-button" aria-label="Send message">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Widget state
    let sessionId = localStorage.getItem('chat-session-id') || null;
    let isOpen = false;
    let isExpanded = false;
    let suggestedActionsShown = true;

    // API Configuration - Environment-aware URL detection
    const API_BASE_URL = (() => {
      // Allow override via global config
      if (window.CHAT_WIDGET_CONFIG?.apiBaseUrl) {
        return window.CHAT_WIDGET_CONFIG.apiBaseUrl;
      }

      // Auto-detect based on hostname
      const hostname = window.location.hostname;

      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return 'http://localhost:3000/api/chat';
      }

      // Production - use same origin as the page
      return `${window.location.protocol}//${window.location.host}/api/chat`;
    })();

    const STREAM_CONTENT_TYPE = 'text/event-stream';

    function isStreamingResponse(response) {
      const contentType = response.headers.get('content-type') || '';
      return contentType.includes(STREAM_CONTENT_TYPE);
    }

    async function readStreamingResponse(response, handlers) {
      if (!response.body || typeof response.body.getReader !== 'function') {
        throw new Error('Streaming not supported in this browser.');
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      let streamClosed = false;

      const processEvent = (eventChunk) => {
        const sanitized = eventChunk.replace(/\r/g, '\n').trim();
        if (!sanitized) return;

        const lines = sanitized.split('\n').filter(Boolean);
        for (const line of lines) {
          if (!line.startsWith('data:')) continue;
          const payload = line.slice(5).trim();
          if (!payload) continue;

          try {
            const parsed = JSON.parse(payload);
            if (parsed.type === 'token' && parsed.content) {
              handlers.onToken?.(parsed.content);
            } else if (parsed.type === 'done') {
              handlers.onDone?.();
            } else if (parsed.type === 'error') {
              const message = parsed.error || 'Sorry, I encountered an error. Please try again.';
              handlers.onError?.(message);
              streamClosed = true;
              return;
            }
          } catch (err) {
            console.error('Failed to parse stream chunk:', err);
          }
        }
      };

      while (!streamClosed) {
        const { value, done } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        let boundary = buffer.indexOf('\n\n');
        while (boundary !== -1) {
          const chunk = buffer.slice(0, boundary);
          buffer = buffer.slice(boundary + 2);
          processEvent(chunk);
          if (streamClosed) {
            await reader.cancel();
            return;
          }
          boundary = buffer.indexOf('\n\n');
        }
      }

      if (buffer.trim() && !streamClosed) {
        processEvent(buffer);
      }
    }

    // DOM Elements
    const chatButton = document.getElementById('chat-button');
    const chatWindow = document.getElementById('chat-window');
    const closeButton = document.getElementById('close-button');
    const expandButton = document.getElementById('expand-button');
    const refreshButton = document.getElementById('refresh-button');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const chatMessages = document.getElementById('chat-messages');
    const typingIndicator = document.getElementById('typing-indicator');
    const suggestedActionsContainer = document.getElementById('suggested-actions');

    // Toggle chat window
    chatButton.addEventListener('click', () => {
      isOpen = !isOpen;
      chatWindow.classList.toggle('active', isOpen);
      if (isOpen) {
        chatInput.focus();
      }
    });

    closeButton.addEventListener('click', () => {
      isOpen = false;
      chatWindow.classList.remove('active');
    });

    // Toggle expanded view
    expandButton.addEventListener('click', () => {
      isExpanded = !isExpanded;
      chatWindow.classList.toggle('expanded', isExpanded);
      const expandIcon = expandButton.querySelector('svg');
      if (isExpanded) {
        expandIcon.innerHTML = '<path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>';
        expandButton.querySelector('.tooltip').textContent = 'Minimize';
      } else {
        expandIcon.innerHTML = '<path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>';
        expandButton.querySelector('.tooltip').textContent = 'Expand';
      }
    });

    // Restart conversation
    refreshButton.addEventListener('click', () => {
      if (confirm('Are you sure you want to restart the conversation? This will clear your chat history.')) {
        // Clear session
        sessionId = null;
        localStorage.removeItem('chat-session-id');

        // Clear messages except welcome
        const messages = chatMessages.querySelectorAll('.message:not(:first-child)');
        messages.forEach(msg => msg.remove());

        // Show suggested actions again
        if (suggestedActionsContainer && !suggestedActionsShown) {
          suggestedActionsContainer.style.display = 'flex';
          suggestedActionsShown = true;
        }

        chatInput.value = '';
        chatInput.focus();
      }
    });

    // Handle suggested actions
    if (suggestedActionsContainer) {
      suggestedActionsContainer.addEventListener('click', (e) => {
        const actionButton = e.target.closest('.suggested-action');
        if (actionButton) {
          const actionText = actionButton.textContent;
          chatInput.value = actionText;
          chatInput.focus();
        }
      });
    }

    // Send message
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      // Disable input
      chatInput.disabled = true;
      sendButton.disabled = true;

      // Add user message to chat
      addMessage('user', message);
      chatInput.value = '';

      // Show typing indicator
      typingIndicator.classList.add('active');

      try {
        const response = await fetch(`${API_BASE_URL}/webhook`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message,
            sessionId,
          }),
        });

        if (!response.ok) {
          throw new Error(`HTTP error ${response.status}`);
        }

        const headerSession = response.headers.get('x-session-id');
        if (headerSession) {
          sessionId = headerSession;
          localStorage.setItem('chat-session-id', sessionId);
        }

        if (isStreamingResponse(response)) {
          const assistantMessage = addMessage('assistant', '');
          const contentNode = assistantMessage?.querySelector('.message-content');
          let assistantText = '';
          let streamFinished = false;

          await readStreamingResponse(response, {
            onToken: (token) => {
              assistantText += token;
              if (contentNode) {
                contentNode.textContent = assistantText;
              }
            },
            onDone: () => {
              streamFinished = true;
              typingIndicator.classList.remove('active');
              if (!assistantText && contentNode) {
                const fallback = 'Thanks for your patience! Please try again.';
                assistantText = fallback;
                contentNode.textContent = fallback;
              }
            },
            onError: (message) => {
              streamFinished = true;
              typingIndicator.classList.remove('active');
              assistantText = message;
              if (contentNode) {
                contentNode.textContent = message;
              }
            },
          }).catch((streamError) => {
            console.error('Streaming error:', streamError);
            if (contentNode) {
              const fallback = 'Sorry, I encountered an error. Please try again.';
              assistantText = fallback;
              contentNode.textContent = fallback;
            }
            typingIndicator.classList.remove('active');
            streamFinished = true;
          });

          if (!streamFinished) {
            typingIndicator.classList.remove('active');
            if (!assistantText && contentNode) {
              const fallback = 'Thanks for your patience! Please try again.';
              assistantText = fallback;
              contentNode.textContent = fallback;
            }
          }
        } else {
          const data = await response.json();

          if (data.sessionId) {
            sessionId = data.sessionId;
            localStorage.setItem('chat-session-id', sessionId);
          }

          typingIndicator.classList.remove('active');
          addMessage('assistant', data.response || 'Sorry, I encountered an error. Please try again.', data.context);
        }

      } catch (error) {
        console.error('Error sending message:', error);
        typingIndicator.classList.remove('active');
        addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
      } finally {
        chatInput.disabled = false;
        sendButton.disabled = false;
        chatInput.focus();
      }
    }

    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Add message to chat
    function addMessage(role, content, context = null) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;

      const now = new Date();
      const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const avatar = role === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';

      let messageHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-wrapper">
          <div class="message-content">${content}</div>
          <div class="message-time">${timeStr}</div>
        </div>
      `;

      if (context) {
        messageHTML += `<div class="context-info">ðŸ“š ${context}</div>`;
      }

      messageDiv.innerHTML = messageHTML;
      
      // Insert before typing indicator
      chatMessages.insertBefore(messageDiv, typingIndicator);
      
      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // Hide suggested actions after first message
      if (suggestedActionsContainer && suggestedActionsShown && role === 'user') {
        suggestedActionsContainer.style.display = 'none';
        suggestedActionsShown = false;
      }

      return messageDiv;
    }

    // End session when page unloads
    window.addEventListener('beforeunload', () => {
      if (sessionId) {
        navigator.sendBeacon(`${API_BASE_URL}/end-session`, JSON.stringify({ sessionId }));
      }
    });
  </script>
</body>
</html>
